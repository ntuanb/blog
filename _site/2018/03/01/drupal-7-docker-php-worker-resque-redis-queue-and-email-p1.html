<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Drupal 7, Docker, PHP Worker, Resque, Redis, Queue and Email Part 1 - Blog</title><link rel="stylesheet" href="https://blog.tuanb.me/css/main.css"><meta name="google-site-verification" content="kfeeGYDzKTHFmlRAJa4qOLf69EM9w4yzLcgcfgdKMEM" /><title>Drupal 7, Docker, PHP Worker, Resque, Redis, Queue and Email Part 1 | Blog</title><meta name="generator" content="Jekyll v3.7.3" /><meta property="og:title" content="Drupal 7, Docker, PHP Worker, Resque, Redis, Queue and Email Part 1" /><meta property="og:locale" content="en_US" /><meta name="description" content="Our task was to create a module that could import users into the database." /><meta property="og:description" content="Our task was to create a module that could import users into the database." /><link rel="canonical" href="https://blog.tuanb.me/https://blog.tuanb.me/2018/03/01/drupal-7-docker-php-worker-resque-redis-queue-and-email-p1.html" /><meta property="og:url" content="https://blog.tuanb.me/https://blog.tuanb.me/2018/03/01/drupal-7-docker-php-worker-resque-redis-queue-and-email-p1.html" /><meta property="og:site_name" content="Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-03-01T00:00:00+11:00" /><script type="application/ld+json"> {"description":"Our task was to create a module that could import users into the database.","@type":"BlogPosting","url":"https://blog.tuanb.me/https://blog.tuanb.me/2018/03/01/drupal-7-docker-php-worker-resque-redis-queue-and-email-p1.html","headline":"Drupal 7, Docker, PHP Worker, Resque, Redis, Queue and Email Part 1","dateModified":"2018-03-01T00:00:00+11:00","datePublished":"2018-03-01T00:00:00+11:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.tuanb.me/https://blog.tuanb.me/2018/03/01/drupal-7-docker-php-worker-resque-redis-queue-and-email-p1.html"},"@context":"http://schema.org"}</script></head><body style="background-color: rgb(255, 255, 255)"><script async src="https://blog.tuanb.me/js/theme.min.js"></script><header> <a href="https://blog.tuanb.me/"><div class="home"></div></a></header><main> <article><h1 class="post-headline">Drupal 7, Docker, PHP Worker, Resque, Redis, Queue and Email Part 1</h1><p class="meta"><small>March 01, 2018</small></p><p>Our task was to create a module that could import users into the database.</p><p>Keep in mind, all the challenges that we had for the required features were tackled as they came up. We were new to Drupal and many of the tools that we were going to use, so we couldn’t really foresee any problems that came up.</p><p>This guide also assumes that basic knowledge of how to create a plugin in Drupal 7 and the usage of a few other tools mentioned above is already known.</p><h1 id="goals">Goals</h1><p>The goals that was laid out at the start was to:</p><ul><li>Use an existing import module</li><li>Import the users without using the internal cron system</li><li>Utilize a seperate storage system for reliability and speed</li><li>Process the queueing independantly</li><li>Log any errors</li></ul><h3 id="existing-import-module">Existing Import Module</h3><p>Was required because we were already using an import tool, which did the job but not fast enough.</p><h3 id="cron-system">Cron System</h3><p>It ran through the cron system which imported around 100 users per minute and ran on each web page load.</p><h3 id="seperate-storage">Seperate Storage</h3><p>We wanted to use a seperate storage because it would function faster if we stored the job in memory. A relational database was too slow.</p><h3 id="process-indepedantly">Process Indepedantly</h3><p>The cron system worked on each request. We wanted to import a large number of users so we needed speed.</p><h3 id="log">Log</h3><p>If a user could not be imported, we wanted it to reliably log where it stopped and why. Losing data was not an option because the data being inserted was too large to sit down and check by eye.</p><h1 id="email">Email</h1><p>First off, we needed a queueing system to be adding into the project that would allow any email sent to be redirected to a queue.</p><p>The hard part about this was integrating it into Drupal in a way that would allow the traditional way of sending emails as an option because we wanted to slowly integrate it into the system. This meant that we needed an on/off where the user could change how emails could be processed.</p><p>By approaching this problem first, we would be able to integrate another feature into the queueing system in the future.</p><p>I picked <a href="https://github.com/resque/resque">Resque</a> to be used after a bit of research because we already had a Redis server running for sessions. By using Redis to store the queue jobs, it would be fast and that data we stored there was independant of the database.</p><h3 id="setup-redis">Setup Redis</h3><p>Any redis server would work as long as we had the correct url, username and password.</p><p>For this project, we used Docker containers <code class="highlighter-rouge">edis:3.2-alpine</code> and <code class="highlighter-rouge">eldadfux/resque-web</code>.</p><h3 id="create-the-generic-module">Create the Generic Module</h3><p>Download and add the plugin into the module folder under <code class="highlighter-rouge">lib</code>.</p><p>Make sure the library is loaded into Drupal’s caching system:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">my_resque_libraries_info</span><span class="p">()</span> <span class="p">{</span>

    <span class="nv">$libraries</span><span class="p">[</span><span class="s1">'resque'</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'PHP Resque'</span><span class="p">,</span>
        <span class="s1">'vendor url'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'download url'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
        <span class="s1">'path'</span> <span class="o">=&gt;</span> <span class="s1">'vendor'</span><span class="p">,</span>
        <span class="s1">'version'</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">'files'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
            <span class="s1">'php'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span><span class="s1">'autoload.php'</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">);</span>

    <span class="k">return</span> <span class="nv">$libraries</span><span class="p">;</span>
    
<span class="p">}</span></code></pre></figure><p>Create 2 function that would give the user the ability to save the mailsystem where the mail will actually be processed.</p><p>The 3 step process for how it would look like when a mail is queued will look like this <code class="highlighter-rouge">mailsystem &gt; queue &gt; custom_mailsystem &gt; mail_processor</code>.</p><p>Mail processor will be <code class="highlighter-rouge">Mailgun</code> for example.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">my_resque_mailsystem_form_alter</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span><span class="p">,</span> <span class="nv">$form_id</span><span class="p">)</span> <span class="p">{</span>

    <span class="o">...</span>

    <span class="nv">$html_select</span> <span class="o">=</span> <span class="s1">'&lt;select name='</span> <span class="o">.</span> <span class="nv">$key</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$module</span> <span class="o">.</span> <span class="s1">'-class'</span> <span class="o">.</span> <span class="s1">' class="form-select"&gt;'</span><span class="p">;</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nx">mailsystem_get_classes</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$class</span><span class="p">)</span> <span class="p">{</span>

            <span class="c1">// Prevent infinite loop to self.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$class</span> <span class="o">==</span> <span class="s1">'myResqueMailSystem'</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

            <span class="nv">$html_select</span> <span class="o">.=</span> <span class="s1">'&lt;option value="'</span> <span class="o">.</span> <span class="nv">$class</span> <span class="o">.</span> <span class="s1">'"'</span><span class="p">;</span>
                <span class="nv">$html_select</span> <span class="o">.=</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$settings</span><span class="p">[</span><span class="nv">$module</span><span class="p">][</span><span class="s1">'class'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$settings</span><span class="p">[</span><span class="nv">$module</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$class</span><span class="p">)</span> <span class="o">?</span> <span class="s1">'selected'</span> <span class="o">:</span> <span class="s1">''</span><span class="p">;</span>
            <span class="nv">$html_select</span> <span class="o">.=</span> <span class="s1">'&gt;'</span> <span class="o">.</span> <span class="nv">$class</span> <span class="o">.</span> <span class="s1">'&lt;/option&gt;'</span><span class="p">;</span>

        <span class="p">}</span>
    <span class="nv">$html_select</span> <span class="o">.=</span> <span class="s1">'&lt;/select&gt;'</span><span class="p">;</span>

    <span class="o">...</span>

<span class="p">}</span>

<span class="k">function</span> <span class="nf">my_resque_mailsystem_form_submit</span><span class="p">(</span><span class="nv">$form</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$form_state</span><span class="p">)</span> <span class="p">{</span>

    <span class="o">...</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$form_state</span><span class="p">[</span><span class="s1">'values'</span><span class="p">]))</span> <span class="p">{</span>

        <span class="nv">$inputs</span> <span class="o">=</span> <span class="nv">$form_state</span><span class="p">[</span><span class="s1">'input'</span><span class="p">];</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nx">mailsystem_get</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$module</span> <span class="o">=&gt;</span> <span class="nv">$mailsystem</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$inputs</span><span class="p">[</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$module</span> <span class="o">.</span> <span class="s1">'-class'</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$settings</span><span class="p">[</span><span class="nv">$module</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$inputs</span><span class="p">[</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'-'</span> <span class="o">.</span> <span class="nv">$module</span> <span class="o">.</span> <span class="s1">'-class'</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$settings</span><span class="p">[</span><span class="nv">$module</span><span class="p">][</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'DefaultMailSystem'</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// Save some other mailsystems that may be related.</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">...</span>

<span class="p">}</span></code></pre></figure><p>Create a generic function where all sub modules will call to add a job to the queue.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">function</span> <span class="nf">my_resque_queue</span><span class="p">(</span><span class="nv">$module</span><span class="p">,</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$variables</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span> <span class="p">{</span>

    <span class="c1">// Check if the library is laoded.</span>
    <span class="nv">$library</span> <span class="o">=</span> <span class="nx">libraries_detect</span><span class="p">(</span><span class="s1">'resque'</span><span class="p">);</span>
  
    <span class="c1">// Lets load it if its not loaded.</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$library</span><span class="p">[</span><span class="s1">'loaded'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nx">cache_clear_all</span><span class="p">(</span><span class="s1">'resque'</span><span class="p">,</span> <span class="s1">'cache_libraries'</span><span class="p">);</span>
        <span class="nx">drupal_static_reset</span><span class="p">(</span><span class="s1">'libraries_load'</span><span class="p">);</span>
        <span class="nx">libraries_load</span><span class="p">(</span><span class="s1">'resque'</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="c1">// Get any variables</span>
    <span class="nv">$key</span> <span class="o">=</span> <span class="s1">'my'</span><span class="p">;</span>
    <span class="nv">$redis_host</span>         <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'_host'</span><span class="p">,</span> <span class="s1">'redis'</span><span class="p">);</span> <span class="c1">// redis because we're using docker named network containers</span>
    <span class="nv">$redis_port</span>         <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'_port'</span><span class="p">,</span> <span class="s1">'6379'</span><span class="p">);</span>
    <span class="nv">$redis_password</span>     <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'_password'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
    <span class="nv">$redis_table</span>        <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="nv">$key</span> <span class="o">.</span> <span class="s1">'_table'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// Connect</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$redis_password</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Resque</span><span class="o">::</span><span class="na">setBackend</span><span class="p">(</span><span class="nv">$redis_host</span> <span class="o">.</span> <span class="s1">':'</span> <span class="o">.</span> <span class="nv">$redis_port</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$redis_table</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">Resque</span><span class="o">::</span><span class="na">setBackend</span><span class="p">(</span><span class="s1">'redis://redis:'</span> <span class="o">.</span> <span class="nv">$redis_password</span> <span class="o">.</span> <span class="s1">'@'</span> <span class="o">.</span> <span class="nv">$redis_host</span> <span class="o">.</span> <span class="s1">':'</span> <span class="o">.</span> <span class="nv">$redis_port</span> <span class="o">.</span> <span class="s1">'/'</span> <span class="o">.</span> <span class="nv">$redis_table</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nv">$token</span> <span class="o">=</span> <span class="nx">Resque</span><span class="o">::</span><span class="na">enqueue</span><span class="p">(</span><span class="nv">$module</span><span class="p">,</span> <span class="nv">$class</span><span class="p">,</span> <span class="nv">$variables</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">);</span>

<span class="p">}</span></code></pre></figure><p>Whats happening here is, the function will load the Resque library that was included above, get all the variables that we have saved. It will the enqueue the job and return the token id of the job.</p><p>If this function is called succesfully, a job should now appear in Redis.</p><h3 id="create-a-mail-mailsytem">Create a Mail Mailsytem</h3><p>Create a new submodule to with the functionality to create a new mailsystem called <code class="highlighter-rouge">MyResqueMailSystem</code>, which is a class that implements <code class="highlighter-rouge">MailSystemInterface</code> in a file called <code class="highlighter-rouge">my_resque_mailsystem.mail.inc</code>.</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">class</span> <span class="nc">MyResqueMailSystem</span> <span class="k">implements</span> <span class="nx">MailSystemInterface</span> <span class="p">{</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">template</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>

        <span class="o">...</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">format</span><span class="p">(</span><span class="k">array</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>
        
        <span class="o">...</span>

    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>This module relies on the <code class="highlighter-rouge">mailsystem</code> module which allows the user to define custom mailing be used, in this case, we wanted all mail to be sent to the queue instead of directly sending to <code class="highlighter-rouge">Mailgun</code>. The queue would then process the job when the time comes and send the mail using Mailgun.</p><p>The trickiest part about this was getting the redirect to work properly.</p><p>Inside the mailsytem class, the format function had the ability to redirect to the right custom mailsystem, which was saved using the form <code class="highlighter-rouge">my_resque_mailsystem_form_alter() {}</code> and <code class="highlighter-rouge">my_resque_mailsystem_form_submit() {}</code></p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="k">public</span> <span class="k">function</span> <span class="nf">format</span><span class="p">(</span><span class="k">array</span> <span class="nv">$message</span><span class="p">)</span> <span class="p">{</span>

    <span class="o">...</span>

    <span class="nv">$settings</span>       <span class="o">=</span> <span class="nx">variable_get</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
    <span class="nv">$instances</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="nx">drupal_static</span><span class="p">(</span><span class="nx">__FUNCTION__</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>

    <span class="nv">$class</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$settings</span><span class="p">[</span><span class="nv">$message</span><span class="p">[</span><span class="s1">'module'</span><span class="p">]]))</span> <span class="p">{</span>
        <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$settings</span><span class="p">[</span><span class="nv">$message</span><span class="p">[</span><span class="s1">'module'</span><span class="p">]][</span><span class="s1">'class'</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$settings</span><span class="p">[</span><span class="s1">'default-system'</span><span class="p">][</span><span class="s1">'class'</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$instances</span><span class="p">[</span><span class="nv">$class</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$interfaces</span> <span class="o">=</span> <span class="nb">class_implements</span><span class="p">(</span><span class="nv">$class</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$interfaces</span><span class="p">[</span><span class="s1">'MailSystemInterface'</span><span class="p">]))</span> <span class="p">{</span>
            <span class="nv">$instances</span><span class="p">[</span><span class="nv">$class</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nv">$class</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="nb">strtr</span><span class="p">(</span><span class="s1">'Class %class does not implement interface %interface'</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'%class'</span> <span class="o">=&gt;</span> <span class="nv">$class</span><span class="p">,</span> <span class="s1">'%interface'</span> <span class="o">=&gt;</span> <span class="s1">'MailSystemInterface'</span>
            <span class="p">]));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="o">...</span>

<span class="p">}</span></code></pre></figure><h3 id="create-the-worker">Create The Worker</h3><p>…// stuff</p><hr class="divider"><div id="disqus_thread"></div><script defer> (function() { var d = document, s = d.createElement('script'); s.src = '//tuanb-me.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the comments</noscript> </article></main><footer><div class="links"> <a href="https://blog.tuanb.me/contact/">Contact</a> <a class="theme" onclick="theme()">Dark/Light</a></div></footer><script src="https://cdn.jsdelivr.net/npm/ga-lite@1/dist/ga-lite.min.js" async></script><script> var galite = galite || {}; galite.UA = 'UA-90397102-1';</script></body></html>
